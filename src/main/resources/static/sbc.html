<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title data-i18n="title.sbc">FODDR | Catálogo de SBCs</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="brand">FODDR</div>
      <div class="header-actions">
        <nav class="nav-links">
          <a href="index.html" data-i18n="nav.calculator">Calculadora</a>
          <a href="sbc.html" data-i18n="nav.sbcs">SBCs</a>
        </nav>
        <div class="lang-switch">
          <span data-i18n="lang.label">Idioma</span>
          <select id="languageSelect" data-i18n-aria-label="lang.label">
            <option value="pt-BR" data-i18n="lang.pt">Português</option>
            <option value="en-US" data-i18n="lang.en">English</option>
          </select>
        </div>
      </div>
    </header>

    <main class="app-main">
      <section class="sbc-panel sbc-catalog">
        <div class="catalog-header">
          <div>
            <p class="catalog-eyebrow" data-i18n="sbc.eyebrow">Squad Building Challenges</p>
            <h1 data-i18n="sbc.heading">Catálogo de SBCs</h1>
            <p data-i18n="sbc.subtitle">Explore as categorias disponíveis e encontre os desafios ativos.</p>
          </div>
          <button type="button" id="reloadCategorias" class="catalog-refresh">
            <span data-i18n="sbc.refresh">Atualizar</span>
          </button>
        </div>

        <div class="catalog-tabs" id="tabs" role="tablist" data-i18n-aria-label="sbc.tabs_label"></div>

        <div class="catalog-content" id="content">
          <div class="catalog-empty catalog-empty--loading" data-i18n="sbc.loading">Carregando SBCs…</div>
        </div>
      </section>
    </main>
  </div>

  <script src="i18n.js"></script>
  <script>
    const API_CATEGORIES = "/api/sbc/categories";
    const tabsContainer = document.getElementById("tabs");
    const contentContainer = document.getElementById("content");
    const reloadBtn = document.getElementById("reloadCategorias");
    const reloadLabel = reloadBtn ? reloadBtn.querySelector("[data-i18n]") || reloadBtn : null;

    const state = {
      categorias: [],
      activeIndex: 0
    };

    const setRefreshLoading = (loading) => {
      if (!reloadBtn) return;
      reloadBtn.disabled = loading;
      if (reloadLabel) {
        reloadLabel.textContent = loading ? t("sbc.refresh_loading") : t("sbc.refresh");
      }
    };

    const showStatusMessage = (message, variant = "muted") => {
      contentContainer.innerHTML = "";
      const box = document.createElement("div");
      const classes = ["catalog-empty"];
      if (variant) {
        classes.push(`catalog-empty--${variant}`);
      }
      box.className = classes.join(" ");
      box.textContent = message;
      contentContainer.appendChild(box);
    };

    const formatExpireDate = (timestamp) => {
      if (!timestamp) return t("sbc.card_no_date");
      const date = new Date(timestamp * 1000);
      if (Number.isNaN(date.getTime())) return t("sbc.card_no_date");
      const locale = getCurrentLocale() || "pt-BR";
      return date.toLocaleDateString(locale, {
        day: "2-digit",
        month: "short",
        hour: "2-digit",
        minute: "2-digit"
      });
    };

    const createMetaRow = (label, value) => {
      const item = document.createElement("li");
      item.className = "catalog-card__meta-item";

      const labelSpan = document.createElement("span");
      labelSpan.className = "catalog-card__meta-label";
      labelSpan.textContent = label;

      const valueSpan = document.createElement("span");
      valueSpan.className = "catalog-card__meta-value";
      valueSpan.textContent = value;

      item.append(labelSpan, valueSpan);
      return item;
    };

    const criarCard = (set = {}) => {
      const card = document.createElement("article");
      card.className = "catalog-card";
      card.setAttribute("role", "button");
      card.setAttribute("tabindex", "0");

      const label = set.name || set.setId
        ? t("sbc.card_open_named", { name: set.name || set.setId })
        : t("sbc.card_open");
      card.setAttribute("aria-label", label);

      const title = document.createElement("h3");
      title.className = "catalog-card__title";
      title.textContent = set.name || t("sbc.card_untitled");
      card.appendChild(title);

      const metaList = document.createElement("ul");
      metaList.className = "catalog-card__meta";
      metaList.appendChild(createMetaRow(t("sbc.card_set_id"), set.setId ?? "—"));
      metaList.appendChild(createMetaRow(t("sbc.card_expires"), formatExpireDate(set.expiresAt)));
      card.appendChild(metaList);

      const action = document.createElement("div");
      action.className = "catalog-card__action";
      const actionText = document.createElement("span");
      actionText.textContent = t("sbc.card_view_details");
      const actionIcon = document.createElement("span");
      actionIcon.setAttribute("aria-hidden", "true");
      actionIcon.textContent = "→";
      action.append(actionText, actionIcon);
      card.appendChild(action);

      const handleActivate = (event) => {
        if (event.type === "keydown" && event.key !== "Enter" && event.key !== " ") {
          return;
        }
        event.preventDefault();
        abrirSet(set.setId);
      };

      card.addEventListener("click", handleActivate);
      card.addEventListener("keydown", handleActivate);

      return card;
    };

    async function carregarCategorias() {
      setRefreshLoading(true);
      showStatusMessage(t("sbc.loading"), "loading");

      try {
        const response = await fetch(API_CATEGORIES, {
          headers: { Accept: "application/json" }
        });

        if (!response.ok) {
          throw new Error(t("common.error_response", { status: response.status }));
        }

        const data = await response.json();

        if (!Array.isArray(data) || data.length === 0) {
          tabsContainer.innerHTML = "";
          showStatusMessage(t("sbc.no_categories"), "muted");
          return;
        }

        renderizar(data);
      } catch (error) {
        console.error("Erro ao carregar SBCs:", error);
        tabsContainer.innerHTML = "";
        showStatusMessage(t("sbc.load_error"), "error");
      } finally {
        setRefreshLoading(false);
      }
    }

    function renderizar(categorias) {
      state.categorias = categorias;
      state.activeIndex = 0;

      tabsContainer.innerHTML = "";
      contentContainer.innerHTML = "";

      categorias.forEach((categoria, index) => {
        const tab = document.createElement("button");
        tab.type = "button";
        tab.className = `catalog-tab${index === 0 ? " is-active" : ""}`;
        tab.textContent = categoria.category || t("sbc.category_label", { index: index + 1 });
        tab.setAttribute("role", "tab");
        tab.setAttribute("aria-selected", index === 0 ? "true" : "false");
        tab.id = `catalog-tab-${index}`;
        tab.setAttribute("aria-controls", `catalog-panel-${index}`);
        tab.addEventListener("click", () => selecionarCategoria(index));
        tabsContainer.appendChild(tab);

        const panel = document.createElement("section");
        panel.className = `catalog-category${index === 0 ? " is-active" : ""}`;
        panel.setAttribute("role", "tabpanel");
        panel.id = `catalog-panel-${index}`;
        panel.setAttribute("aria-labelledby", tab.id);
        panel.hidden = index !== 0;

        const sets = Array.isArray(categoria.sets) ? categoria.sets : [];

        if (sets.length === 0) {
          const empty = document.createElement("div");
          empty.className = "catalog-empty catalog-empty--muted";
          empty.textContent = t("sbc.no_sets_in_category");
          panel.appendChild(empty);
        } else {
          const grid = document.createElement("div");
          grid.className = "catalog-grid";
          sets.forEach((setInfo) => grid.appendChild(criarCard(setInfo)));
          panel.appendChild(grid);
        }

        contentContainer.appendChild(panel);
      });
    }

    function selecionarCategoria(index) {
      state.activeIndex = index;

      const tabs = tabsContainer.querySelectorAll(".catalog-tab");
      const panels = contentContainer.querySelectorAll(".catalog-category");

      tabs.forEach((tab, idx) => {
        const isActive = idx === index;
        tab.classList.toggle("is-active", isActive);
        tab.setAttribute("aria-selected", isActive ? "true" : "false");
      });

      panels.forEach((panel, idx) => {
        const isActive = idx === index;
        panel.classList.toggle("is-active", isActive);
        panel.hidden = !isActive;
      });
    }

    function abrirSet(setId) {
      if (!setId) {
        console.warn("Set sem identificador");
        return;
      }

      window.location.href = `sbc-set.html?setId=${encodeURIComponent(setId)}`;
    }

    if (reloadBtn) {
      reloadBtn.addEventListener("click", carregarCategorias);
    }

    carregarCategorias();
  </script>
</body>
</html>
